<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AXIS | Tu Mapa Interno</title>
  
  <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --bg: #F4EFE9;
      --dark: #274E55;
      --accent: #FF7F66;
      --text: #3A3A3A;
      --white: #FFFFFF;
      --shadow: 0 10px 30px rgba(39, 78, 85, 0.08);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
    
    /* --- UTILIDADES --- */
    .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.6s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* --- TIPOGRAF√çA --- */
    h1, h2, h3 { font-family: 'Poppins', sans-serif; color: var(--dark); }
    h1 { font-size: clamp(2rem, 5vw, 3.5rem); line-height: 1.1; margin-bottom: 1.5rem; }
    h2 { font-size: 2rem; margin-bottom: 1rem; }
    p { margin-bottom: 1.5rem; color: #555; }
    .highlight { color: var(--accent); }

    /* --- BOTONES --- */
    .btn {
      background: var(--accent); color: var(--white); border: none; padding: 15px 40px;
      border-radius: 50px; font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s; display: inline-block;
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255, 127, 102, 0.3); }
    .btn-secondary { background: transparent; border: 2px solid var(--dark); color: var(--dark); margin-left: 10px; }

    /* --- HEADER & HERO --- */
    header { padding: 20px 0; }
    .logo { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.5rem; color: var(--dark); cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .logo-icon { background: var(--dark); color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    .hero-section { padding: 80px 0; text-align: left; }
    .badge { background: rgba(46, 89, 65, 0.1); color: var(--verde-bosque); padding: 6px 14px; border-radius: 30px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; display: inline-block; margin-bottom: 20px; }

    /* --- CARDS --- */
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 60px 0; }
    .card { background: var(--white); padding: 30px; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5); }
    .card h3 { font-size: 1.2rem; margin-bottom: 10px; }

    /* --- FORMULARIO --- */
    .form-box { background: var(--white); padding: 40px; border-radius: 20px; box-shadow: var(--shadow); max-width: 600px; margin: 0 auto; }
    .input-group { margin-bottom: 20px; text-align: left; position: relative; }
    label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark); }
    input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif; }
    
    /* BUSCADOR CIUDAD */
    .suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; }
    .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .suggestion-item:hover { background: #f9f9f9; }

    /* --- QUIZ --- */
    .quiz-container { max-width: 700px; margin: 40px auto; text-align: center; }
    .progress-track { background: #e0e0e0; height: 6px; border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
    .question-text { font-size: 1.4rem; font-weight: 600; color: var(--dark); margin-bottom: 40px; min-height: 60px; }
    .options { display: flex; flex-direction: column; gap: 10px; }
    .option-btn { background: var(--white); border: 1px solid #ddd; padding: 15px; border-radius: 10px; cursor: pointer; text-align: left; transition: 0.2s; display: flex; align-items: center; gap: 15px; }
    .option-btn:hover { border-color: var(--accent); background: #fff5f5; transform: translateX(5px); }
    .circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; }
    .option-btn:hover .circle { border-color: var(--accent); }

    /* --- RESULTADO --- */
    .result-header { text-align: center; margin-bottom: 40px; }
    .astro-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 30px; }
    .astro-box { background: var(--white); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
    .astro-label { font-size: 0.7rem; text-transform: uppercase; color: #888; font-weight: 700; display: block; }
    .astro-value { font-weight: 700; color: var(--dark); font-size: 1.1rem; }

    /* --- IA REPORT & PAYWALL --- */
    .report-container { position: relative; background: var(--white); padding: 40px; border-radius: 20px; box-shadow: var(--shadow); text-align: left; }
    .ai-text { color: #444; line-height: 1.8; }
    .ai-text h3 { margin-top: 25px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
    .blur { filter: blur(6px); opacity: 0.5; user-select: none; pointer-events: none; }
    
    .paywall-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.2), #fff 60%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 10; padding-top: 100px;
    }
    
    /* --- LOADER --- */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      h1 { font-size: 2.5rem; }
      .astro-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="logo" onclick="location.reload()">
      <div class="logo-icon">X</div> AXIS
    </div>
  </header>

  <div id="view-home" class="fade-in">
    <section class="hero-section">
      <span class="badge">Psicolog√≠a + Astrolog√≠a</span>
      <h1>Descubr√≠ tu verdadero<br><span class="highlight">Mapa Interno.</span></h1>
      <p style="max-width: 600px; font-size: 1.1rem;">
        AXIS une la precisi√≥n del <strong>Eneagrama</strong> con la profundidad de tu <strong>Carta Astral</strong>. 
        Un an√°lisis √∫nico potenciado por Inteligencia Artificial para entender qui√©n sos, c√≥mo sent√≠s y hacia d√≥nde vas.
      </p>
      <div style="margin-top: 30px;">
        <button class="btn" onclick="nav('view-form')">COMENZAR TEST</button>
        </div>
    </section>

    <section class="cards-grid">
      <div class="card">
        <h3>üß† El Eneagrama</h3>
        <p>No es solo un n√∫mero. Es un mapa de tus motivaciones, miedos y deseos inconscientes. Descubre tu Tipo, Ala y Subtipo.</p>
      </div>
      <div class="card">
        <h3>‚ú® La Carta Astral</h3>
        <p>Calculamos tu Sol, Luna, Ascendente, Marte, Venus y Mercurio exactos para ver c√≥mo los astros colorean tu psicolog√≠a.</p>
      </div>
      <div class="card">
        <h3>ü§ñ La Fusi√≥n AXIS</h3>
        <p>Nuestra IA cruza ambos sistemas para darte un reporte de integraci√≥n √∫nico, imposible de obtener en tests separados.</p>
      </div>
    </section>
  </div>

  <div id="view-form" class="hidden fade-in" style="padding: 40px 0;">
    <div class="form-box">
      <h2 style="text-align: center;">Tus Coordenadas</h2>
      <p style="text-align: center;">Necesitamos tus datos exactos para la precisi√≥n astron√≥mica.</p>
      
      <form onsubmit="startQuiz(event)">
        <div class="input-group">
          <label>Nombre</label>
          <input type="text" id="name" required placeholder="Tu nombre">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="input-group">
            <label>Fecha de Nacimiento</label>
            <input type="date" id="date" required>
          </div>
          <div class="input-group">
            <label>Hora Exacta</label>
            <input type="time" id="time" required>
          </div>
        </div>

        <div class="input-group">
          <label>Lugar de Nacimiento</label>
          <input type="text" id="city-input" placeholder="Escribe y selecciona..." autocomplete="off" oninput="handleCityInput(this.value)">
          <input type="hidden" id="lat">
          <input type="hidden" id="lon">
          <div id="suggestions" class="suggestions"></div>
        </div>

        <button class="btn" style="width: 100%;">IR A LAS PREGUNTAS</button>
      </form>
    </div>
  </div>

  <div id="view-quiz" class="hidden fade-in">
    <div class="quiz-container">
      <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
      <div class="question-text" id="q-text">Cargando...</div>
      
      <div class="options" id="options-box">
        </div>
    </div>
  </div>

  <div id="view-loading" class="hidden fade-in" style="text-align: center; padding: 100px 0;">
    <div class="loader"></div>
    <h3>Analizando...</h3>
    <p>Calculando posiciones planetarias y cruzando datos.</p>
  </div>

  <div id="view-result" class="hidden fade-in">
    <div class="result-header">
      <span class="badge" style="background: #E6F4EA; color: #1E8E3E;">‚úì REPORTE GENERADO</span>
      <h2>Tu Mapa AXIS</h2>
      <p>Hola <strong id="res-name"></strong>, este es tu dise√±o √∫nico.</p>
    </div>

    <div class="astro-grid">
      <div class="astro-box" style="background: var(--dark); color: white; border:none;">
        <span class="astro-label" style="color: rgba(255,255,255,0.7);">ENEATIPO</span>
        <div class="astro-value" id="res-type" style="color: white;">...</div>
      </div>
      <div class="astro-box">
        <span class="astro-label">SOL (ESENCIA)</span>
        <div class="astro-value" id="res-sun">...</div>
      </div>
      <div class="astro-box" style="opacity: 0.5;">
        <span class="astro-label">LUNA (EMOCI√ìN)</span>
        <div class="astro-value">üîí</div>
      </div>
    </div>

    <div class="report-container">
      <div id="ai-content" class="ai-text blur">
        <h3>Tu Arquitectura Psicol√≥gica</h3>
        <p>Lorem ipsum...</p>
      </div>

      <div id="paywall" class="paywall-overlay">
        <h3 style="color: var(--dark);">Desbloquear Lectura Completa</h3>
        <p>Accede a tu an√°lisis profundo de Eneagrama + Carta Astral.</p>
        
        <ul style="text-align: left; margin-bottom: 20px; list-style: none; color: #555;">
          <li>üîí Tu <strong>Ala Dominante</strong> y Subtipo</li>
          <li>üîí Tu <strong>Luna, Ascendente, Marte, Venus</strong></li>
          <li>üîí An√°lisis de <strong>Compatibilidad Interna</strong></li>
          <li>üîí Consejo de <strong>Integraci√≥n</strong></li>
        </ul>

        <div style="background: var(--dark); color: white; padding: 5px 15px; border-radius: 8px; font-weight: 700; margin-bottom: 15px;">$5.000 ARS</div>
        <button class="btn" onclick="unlockReport()">DESBLOQUEAR AHORA</button>
      </div>
    </div>
    <div id="error-msg" style="color: red; text-align: center; margin-top: 20px; display: none;"></div>
  </div>

</div>

<script>
  // --- ESTADO ---
  let user = { name: "", date: "", time: "", city: "", lat: 0, lon: 0 };
  let scores = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0};
  let qIdx = 0;

  // --- 100 PREGUNTAS (Inserta aqu√≠ la lista completa) ---
  // He puesto 10 de ejemplo para que el c√≥digo sea manejable aqu√≠, 
  // pero t√∫ pega las 100 que definimos antes dentro de estos corchetes.
  const questions = [
      {t:1, q:"Siento una fuerte presi√≥n interna por corregir lo que est√° mal."},
      {t:6, q:"Suelo imaginar escenarios negativos por seguridad."},
      {t:3, q:"Me importa mucho mi imagen y mis logros."},
      {t:2, q:"Me ocupo m√°s de otros que de m√≠ mismo."},
      {t:9, q:"Prefiero ceder para evitar conflictos."},
      {t:8, q:"No tengo miedo de confrontar si es necesario."},
      {t:4, q:"A veces siento que nadie me entiende realmente."},
      {t:7, q:"Me aburro r√°pido y busco planes nuevos."},
      {t:5, q:"Necesito tiempo a solas para recargarme."},
      {t:1, q:"Me irrito cuando veo a alguien rompiendo reglas."},
      // ... PEGA AQU√ç EL RESTO DE LAS 100 PREGUNTAS
  ];

  // --- NAVEGACI√ìN ---
  function nav(id) {
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
  }

  // --- BUSCADOR DE CIUDAD (API Nominatim) ---
  let debounce;
  async function handleCityInput(query) {
    clearTimeout(debounce);
    const box = document.getElementById('suggestions');
    if (query.length < 3) { box.style.display = 'none'; return; }

    debounce = setTimeout(async () => {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await res.json();
        
        box.innerHTML = '';
        if(data.length > 0) {
          box.style.display = 'block';
          data.forEach(place => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerText = place.display_name;
            div.onclick = () => selectCity(place);
            box.appendChild(div);
          });
        }
      } catch (e) { console.error(e); }
    }, 300);
  }

  function selectCity(place) {
    document.getElementById('city-input').value = place.display_name;
    document.getElementById('lat').value = place.lat;
    document.getElementById('lon').value = place.lon;
    document.getElementById('suggestions').style.display = 'none';
    user.lat = parseFloat(place.lat);
    user.lon = parseFloat(place.lon);
  }

  // --- INICIO QUIZ ---
  function startQuiz(e) {
    e.preventDefault();
    user.name = document.getElementById('name').value;
    user.date = document.getElementById('date').value;
    user.time = document.getElementById('time').value;
    
    // Si no seleccion√≥ ciudad del men√∫, usamos lat/lon default (0,0) o alertamos
    if(!user.lat) { alert("Por favor selecciona una ciudad de la lista."); return; }

    nav('view-quiz');
    renderQ();
  }

  // --- MOTOR DEL QUIZ ---
  function renderQ() {
    if (qIdx >= questions.length) { finish(); return; }
    document.getElementById('q-text').innerText = questions[qIdx].q;
    document.getElementById('progress-bar').style.width = ((qIdx / questions.length) * 100) + "%";
    
    let html = '';
    [1,2,3,4,5].forEach(val => {
      let label = val===1 ? "No" : val===5 ? "S√≠" : "";
      html += `<div class="option-btn" onclick="vote(${val})">
                 <div class="circle"></div> <strong>${val}</strong> ${label}
               </div>`;
    });
    document.getElementById('options-box').innerHTML = html;
  }

  function vote(pts) {
    scores[questions[qIdx].t] += pts;
    qIdx++;
    renderQ();
  }

  // --- C√ÅLCULOS FINALES ---
  async function finish() {
    nav('view-loading');

    // 1. ENEAGRAMA
    let max = 0, type = 1;
    for (let t in scores) { if (scores[t] > max) { max = scores[t]; type = t; } }
    
    // Ala
    let tInt = parseInt(type);
    let prev = tInt===1?9:tInt-1;
    let next = tInt===9?1:tInt+1;
    let wing = scores[prev] > scores[next] ? prev : next;

    // 2. ASTROLOG√çA (Astronomy Engine)
    const dateObj = new Date(user.date + 'T' + user.time);
    const observer = new Astronomy.Observer(user.lat, user.lon, 0);
    
    const getSign = (body) => {
      const equ = Astronomy.Equator(body, dateObj, observer, true, true);
      const ecl = Astronomy.Horizon(dateObj, observer, equ.ra, equ.dec, 'normal');
      // Nota: Astronomy Engine da coordenadas. Para simplificar, usaremos una funci√≥n auxiliar 
      // que calcula la longitud ecl√≠ptica para el signo tropical.
      const vector = Astronomy.HelioVector(body, dateObj);
      // Simplificaci√≥n para esta demo: Usamos la funci√≥n simple para el Sol y la IA para el resto
      // Para producci√≥n real, usar√≠amos la longitud ecl√≠ptica exacta.
      return "Calculado"; 
    };
    
    // C√°lculo simplificado del Sol para visualizaci√≥n inmediata
    const sunSign = getZodiacSimple(dateObj.getDate(), dateObj.getMonth() + 1);
    
    // 3. PREPARAR DATOS PARA IA
    const astrosIA = {
      sol: sunSign,
      luna: "Calculado por IA seg√∫n fecha/hora",
      asc: "Calculado por IA seg√∫n hora/lat/lon",
      mercurio: "Calculado por IA",
      venus: "Calculado por IA",
      marte: "Calculado por IA"
    };

    document.getElementById('res-name').innerText = user.name;
    document.getElementById('res-type').innerText = "Tipo " + type;
    document.getElementById('res-sun').innerText = sunSign;

    // 4. LLAMADA A VERCEL (IA)
    try {
      const res = await fetch('/api/reporte', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre: user.name,
          eneatipo: type,
          ala: wing,
          astros: astrosIA // Enviamos datos para que la IA afine
        })
      });

      const data = await res.json();
      if(data.error) throw new Error(data.error);
      
      document.getElementById('ai-content').innerHTML = data.reporte;

    } catch (e) {
      document.getElementById('error-msg').innerText = "Error: " + e.message;
      document.getElementById('error-msg').style.display = 'block';
      // Texto de respaldo
      document.getElementById('ai-content').innerHTML = "<h3>Tu An√°lisis</h3><p>Tu perfil muestra una fuerte inclinaci√≥n hacia la seguridad y la estructura...</p>";
    }

    nav('view-result');
  }

  function getZodiacSimple(d, m) {
    if((m==1&&d<=19)||(m==12&&d>=22)) return "Capricornio";
    if((m==1&&d>=20)||(m==2&&d<=18)) return "Acuario";
    if((m==2&&d>=19)||(m==3&&d<=20)) return "Piscis";
    if((m==3&&d>=21)||(m==4&&d<=19)) return "Aries";
    if((m==4&&d>=20)||(m==5&&d<=20)) return "Tauro";
    if((m==5&&d>=21)||(m==6&&d<=20)) return "G√©minis";
    if((m==6&&d>=21)||(m==7&&d<=22)) return "C√°ncer";
    if((m==7&&d>=23)||(m==8&&d<=22)) return "Leo";
    if((m==8&&d>=23)||(m==9&&d<=22)) return "Virgo";
    if((m==9&&d>=23)||(m==10&&d<=22)) return "Libra";
    if((m==10&&d>=23)||(m==11&&d<=21)) return "Escorpio";
    return "Sagitario";
  }

  function unlockReport() {
    if(confirm("Ir a Mercado Pago para abonar $5.000?")) {
      document.getElementById('paywall').style.display = 'none';
      document.getElementById('ai-content').classList.remove('blur');
    }
  }
</script>
</body>
</html>